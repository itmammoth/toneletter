(function($){var LANG={th:{phonetics:{W:"ʉ",U:"ə",E:"ɛ",O:"ɔ",N:"ŋ"},toneKeys:["1","2","3","4","5"]},cn:{phonetics:{U:"ü"},toneKeys:["1","4",null,"2","3"]}};var pluginMethods={init:function(options){var settings=$.extend({},options);return this.each(function(){var $this=$(this);var toneLetterInput=new ToneLetterInput(this,settings);toneLetterInput.observe();$this.data("toneletter",toneLetterInput)})},addTone:function(toneNumber){return this.each(function(){toneLetterInput=$(this).data("toneletter");toneLetterInput.addTone(Number(toneNumber)-1)})},off:function(){return this.each(function(){toneLetterInput=$(this).data("toneletter");toneLetterInput.off()})}};$.fn.toneletter=function(method){if(pluginMethods[method]){return pluginMethods[method].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof method==="object"||!method){return pluginMethods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist on jQuery.toneletter")}};var TONE_CONVERT_TABLE={i:["ī","ì","î","í","ǐ"],e:["ē","è","ê","é","ě"],"ɛ":["ɛ̄","ɛ̀","ɛ̂","ɛ́","ɛ̌"],"ʉ":["ʉ̄","ʉ̀","ʉ̂","ʉ́","ʉ̌"],"ə":["ə̄","ə̀","ə̂","ə́","ə̌"],a:["ā","à","â","á","ǎ"],u:["ū","ù","û","ú","ǔ"],o:["ō","ò","ô","ó","ǒ"],"ɔ":["ɔ̄","ɔ̀","ɔ̂","ɔ́","ɔ̌"],"ü":["ǖ","ǜ","","ǘ","ǚ"]};var TONE_SYMBOLS=["̄","̀","̂","́","̌"];var ToneLetterInput=function(){var ToneLetterInput=function(el,settings){this.settings=settings;this.el=el;this.$el=$(el);this.callbacks={};this.__addPhoneticCallbacks(),this.__addToneCallbacks()};ToneLetterInput.prototype={observe:function(){this.$el.on("keypress.toneletter",this.__keyPress.bind(this))},off:function(){this.$el.off(".toneletter")},addTone:function(toneNumber,pressedKey){this.previousCharacter=this.__getPreviousCharacter();if(this.__isConvertable(this.previousCharacter)){this.__insertTone(this.__convertToTone(toneNumber))}else if(pressedKey){this.__insert(pressedKey)}},__keyPress:function(e){var callback=this.callbacks[this.__getPressedChar(e)];if(!callback)return;callback();e.preventDefault()},__addPhoneticCallbacks:function(){var phonetics=$.extend(true,{},LANG[this.settings.lang].phonetics,this.settings.phonetics);var that=this;$.each(phonetics,function(key,value){that.callbacks[key]=function(){that.__insert(value)}})},__addToneCallbacks:function(toneKeys){var toneKeys=this.settings.toneKeys||LANG[this.settings.lang].toneKeys;var that=this;$.each(toneKeys,function(i,key){if(key==null||key==="")return;that.callbacks[key]=function(){that.addTone(i,key)}})},__getPressedChar:function(e){var charCode=e.keyCode!=0?e.keyCode:e.charCode;return String.fromCharCode(charCode)},__getCursorPosition:function(){return this.el.selectionEnd},__insertTone:function(tone){this.__backspace();this.__insert(tone)},__insert:function(character){var at=this.__getCursorPosition();this.el.value=this.el.value.slice(0,at)+character+this.el.value.slice(at);this.__setCursor(at+character.length)},__setCursor:function(position){this.el.focus();this.el.selectionStart=this.el.selectionEnd=position},__getPreviousCharacter:function(){var position=this.__getCursorPosition();var prevChar=this.el.value.charAt(position-1);if(prevChar==="")return prevChar;if(this.__isTone(prevChar)){return this.el.value.charAt(position-2)}return this.__removeTone(prevChar)},__isTone:function(character){return TONE_SYMBOLS.indexOf(character)>-1},__isConvertable:function(character){return TONE_CONVERT_TABLE[character]!==undefined},__convertToTone:function(toneNumber){return TONE_CONVERT_TABLE[this.previousCharacter][toneNumber]},__backspace:function(){var from=this.__getCursorPosition();var length=this.__calcBSLength(from,this.previousCharacter);this.el.value=this.el.value.slice(0,from-length)+this.el.value.slice(from);this.__setCursor(from-length)},__calcBSLength:function(position,character){return this.el.value.substring(0,position).split("").reverse().map(this.__removeTone).indexOf(character)+1},__removeTone:function(character){for(var vowel in TONE_CONVERT_TABLE){if(TONE_CONVERT_TABLE[vowel].indexOf(character)>-1){return vowel}}return character}};return ToneLetterInput}()})(jQuery);
